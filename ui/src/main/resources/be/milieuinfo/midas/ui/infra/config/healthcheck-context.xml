<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:jee="http://www.springframework.org/schema/jee"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
       http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd">

    <context:annotation-config/>

    <jee:jndi-lookup id="healthcheckDataSource" jndi-name="jdbc/midas"/>

    <task:scheduled-tasks>
        <task:scheduled ref="healthCheckCronJob" method="checkJobs" fixed-rate="60000"/>
    </task:scheduled-tasks>

    <bean id="statusHolder" class="be.milieuinfo.healthcheck.model.StatusHolder" scope="singleton"/>

    <bean id="healthCheckFilter" class="be.milieuinfo.healthcheck.web.filter.HealthCheckFilter">
        <property name="statusHolder" ref="statusHolder"/>
    </bean>

    <bean id="healthCheckCronJob" class="be.milieuinfo.healthcheck.cron.HealthCheckCronJob">
        <property name="statusHolder" ref="statusHolder"/>
        <property name="criticalJobs">
            <list value-type="be.milieuinfo.healthcheck.job.AbstractHealthCheckJob">
                <ref bean="midasDatabase"/>
                <ref bean="identityWebserviceJob"/>
            </list>
        </property>
        <property name="nonCriticalJobs">
            <list value-type="be.milieuinfo.healthcheck.job.AbstractHealthCheckJob">
            </list>
        </property>
    </bean>

    <bean id="midasDatabase" class="be.milieuinfo.healthcheck.job.DatabaseHealthCheckJob">
        <property name="dataSource" ref="healthcheckDataSource"/>
        <property name="sqlStatement" value="select 1;"/>
        <property name="logicalName" value="Midas Database"/>
    </bean>


    <!-- Webservices -->
    <bean id="identityWebserviceJob" class="be.milieuinfo.healthcheck.job.WSDLHealthCheckJob">
        <property name="logicalName" value="IdentityServices Webservice"/>
        <property name="url" value="${identityServices.baseurl}/identityservices/IdentityServices?wsdl"/>
    </bean>

    <!-- JMX Exporter -->
    <bean id="exporter" class="org.springframework.jmx.export.MBeanExporter" lazy-init="false">
        <property name="autodetect" value="true"/>
        <property name="namingStrategy" ref="namingStrategy"/>
        <property name="assembler" ref="assembler"/>
        <property name="registrationPolicy" value="IGNORE_EXISTING"/>
    </bean>

    <bean id="attributeSource" class="org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"/>

    <bean id="assembler" class="org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler">
        <property name="attributeSource" ref="attributeSource"/>
    </bean>

    <bean id="namingStrategy" class="org.springframework.jmx.export.naming.IdentityNamingStrategy"/>

    <bean id="healthCheckStatusBean" class="be.milieuinfo.healthcheck.jmx.HealthCheckStatusBean">
        <property name="statusHolder" ref="statusHolder"/>
    </bean>

</beans>